<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WeChat | Public Chat</title>
  <style>
    body {
      background-color: #111;
      color: #fff;
      font-family: monospace;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }

    section {
      display: none;
    }

    #create-account {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .select-pfp {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .select-pfp img {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      border: 2px solid #f77;
    }

    .username-input {
      margin-top: 20px;
      padding: 10px;
      border: none;
      border-bottom: 2px solid #f77;
      background: transparent;
      color: #fff;
      text-align: center;
    }

    .create-account-message {
      margin-top: 10px;
      color: #f77;
    }

    #chat {
      display: flex;
      flex-direction: column;
      width: 100%;
      height: 100%;
      padding: 20px;
    }

    .main-chat-interface {
      flex: 1;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .chat-container {
      display: flex;
      flex-direction: column;
      max-width: 100%;
    }

    .sent {
      align-items: flex-end;
    }

    .received {
      align-items: flex-start;
    }

    .chat-container img {
      border-radius: 50%;
    }

    .input-box {
      display: flex;
      margin-top: 10px;
    }

    .input-box input {
      flex: 1;
      padding: 10px;
      border: none;
      background: #222;
      color: #fff;
    }

    .input-box button {
      background: #f77;
      border: none;
      padding: 10px;
      color: #fff;
    }
  </style>
</head>
<body>
  <section id="create-account">
    <div class="select-pfp">
      <button class="select-pfp-back-btn">&larr;</button>
      <img src="profile pictures/car.jpg">
      <button class="select-pfp-next-btn">&rarr;</button>
    </div>
    <input type="text" class="username-input" placeholder="Enter a unique username">
    <button class="create-account-next-btn">Next</button>
    <span class="create-account-message"></span>
  </section>

  <section id="chat">
    <div class="main-chat-interface"></div>
    <div class="input-box">
      <input type="text" class="message-input" placeholder="Type your message here">
      <button class="send-btn">Send</button>
    </div>
  </section>

  <script>
    const profilepictures = [
      'profile pictures/buddha.jpg',
      'profile pictures/adidas.jpg',
      'profile pictures/barcelona.jpg',
      'profile pictures/car.jpg',
      'profile pictures/messi.jpg',
      'profile pictures/defult.jpg',
      'profile pictures/drawing.jpg',
      'profile pictures/laptop.jpg',
      'profile pictures/spiderman.jpg'
    ];

    const userInput = document.querySelector('.username-input');
    const createAccountNextBtn = document.querySelector('.create-account-next-btn');
    const createAccountSection = document.querySelector('#create-account');
    const chatSection = document.querySelector('#chat');
    const pfpBtnNext = document.querySelector('.select-pfp-next-btn');
    const pfpBtnBack = document.querySelector('.select-pfp-back-btn');
    const pfp = document.querySelector('.select-pfp img');
    const createAccountMsg = document.querySelector('.create-account-message');
    const messageInput = document.querySelector('.message-input');
    const sendBtn = document.querySelector('.send-btn');
    const chatInterface = document.querySelector('.main-chat-interface');

    const API_URL = 'https://api.jsonbin.io/v3/b/687ce881ee4b395e61f23b17';
    const API_LATEST = `${API_URL}/latest`;
    const HEADERS = {
      'X-Master-Key': '$2a$10$fv8piFnoMQmqN2haULO6B.J7lBcThIhQmnhQqchrj1CuG3uJ6E95m',
      'Content-Type': 'application/json'
    };

    let messages = [];
    let pfpIndex = 0;
    pfp.src = profilepictures[pfpIndex];

    pfpBtnBack.onclick = () => {
      pfpIndex = (pfpIndex - 1 + profilepictures.length) % profilepictures.length;
      pfp.src = profilepictures[pfpIndex];
    };

    pfpBtnNext.onclick = () => {
      pfpIndex = (pfpIndex + 1) % profilepictures.length;
      pfp.src = profilepictures[pfpIndex];
    };

    createAccountNextBtn.addEventListener('click', () => {
      const username = userInput.value.trim();
      if (username.length >= 3) {
        localStorage.setItem('username', username);
        localStorage.setItem('pfp', profilepictures[pfpIndex]);
        createAccountSection.style.display = 'none';
        chatSection.style.display = 'flex';
        loadMessages();
      } else {
        createAccountMsg.textContent = 'The username must be at least 3 characters';
      }
    });

    function loadMessages() {
      fetch(API_LATEST, { headers: HEADERS })
        .then(res => res.json())
        .then(data => {
          chatInterface.innerHTML = '';
          messages = data.record || [];
          const currentUser = localStorage.getItem('username');

          messages.forEach(msg => {
            const isSent = msg.username === currentUser;
            const container = document.createElement('div');
            container.className = `chat-container ${isSent ? 'sent' : 'received'}`;

            container.innerHTML = `
              <div style="display: flex; align-items: center; gap: 10px; ${isSent ? 'justify-content: flex-end; flex-direction: row-reverse;' : ''}">
                <img src="${msg.pfp}" width="40" height="40">
                <div style="background: #222; padding: 10px; border-radius: 10px; color: #fff; max-width: 60%;">
                  <strong>${msg.username}</strong><br>
                  <span>${msg.message}</span>
                </div>
              </div>
            `;

            chatInterface.appendChild(container);
          });
        })
        .catch(err => console.error('Failed to fetch messages:', err));
    }

    function sendMessage() {
      const message = messageInput.value.trim();
      if (!message) return;

      const newMsg = {
        username: localStorage.getItem('username'),
        pfp: localStorage.getItem('pfp'),
        date: new Date().toISOString(),
        message: message
      };

      messages.push(newMsg);

      fetch(API_URL, {
        method: 'PUT',
        headers: HEADERS,
        body: JSON.stringify(messages)
      })
      .then(res => res.json())
      .then(() => {
        messageInput.value = '';
        loadMessages();
      })
      .catch(err => console.error('Failed to send message:', err));
    }

    sendBtn.addEventListener('click', sendMessage);
    messageInput.addEventListener('keypress', e => {
      if (e.key === 'Enter') sendMessage();
    });

    function whileLoading() {
      if (localStorage.getItem('username')) {
        createAccountSection.style.display = 'none';
        chatSection.style.display = 'flex';
        loadMessages();
      } else {
        createAccountSection.style.display = 'flex';
      }
    }

    whileLoading();
    setInterval(loadMessages, 500);
  </script>
</body>
</html>
